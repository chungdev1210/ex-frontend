<div class="card">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">Roles Management</h2>
        <p-button label="New Role" icon="pi pi-plus" (onClick)="openNew()" />
    </div>

    <p-table #dt [value]="roles$()" [loading]="loading$()" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[10, 25, 50]" [globalFilterFields]="['name', 'description']" responsiveLayout="scroll">
        <ng-template pTemplate="caption">
            <div class="flex">
                <span class="p-input-icon-left ml-auto">
                    <input pInputText type="text" #searchInput (input)="dt.filterGlobal(searchInput.value, 'contains')" placeholder="Search..." />
                </span>
            </div>
        </ng-template>

        <ng-template pTemplate="header">
            <tr>
                <th pSortableColumn="name">Name <p-sortIcon field="name" /></th>
                <th pSortableColumn="description">Description <p-sortIcon field="description" /></th>
                <th pSortableColumn="priority">Priority <p-sortIcon field="priority" /></th>
                <th>Permissions</th>
                <th pSortableColumn="isActive">Status <p-sortIcon field="isActive" /></th>
                <th style="width: 200px">Actions</th>
            </tr>
        </ng-template>

        <ng-template pTemplate="body" let-role>
            <tr>
                <td>{{ role.name }}</td>
                <td>{{ role.description || '-' }}</td>
                <td>{{ role.priority || 0 }}</td>
                <td>
                    <p-badge [value]="role.permissions?.length || 0" severity="info" />
                </td>
                <td>
                    <p-tag [value]="role.isActive ? 'Active' : 'Inactive'" [severity]="role.isActive ? 'success' : 'danger'" />
                </td>
                <td>
                    <div class="flex gap-2">
                        <p-button icon="pi pi-shield" [rounded]="true" [text]="true" severity="success" (onClick)="assignPermissions(role)" pTooltip="Assign Permissions" />
                        <p-button icon="pi pi-pencil" [rounded]="true" [text]="true" severity="info" (onClick)="edit(role)" pTooltip="Edit" />
                        <p-button icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger" (onClick)="delete(role)" pTooltip="Delete" />
                    </div>
                </td>
            </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="6" class="text-center">No roles found.</td>
            </tr>
        </ng-template>
    </p-table>
</div>

<p-dialog [(visible)]="dialogVisible" [header]="dialogMode() === 'create' ? 'New Role' : 'Edit Role'" [modal]="true" [style]="{ width: '600px' }" [draggable]="false" [resizable]="false">
    <app-role-form [role]="selectedRole()" [mode]="dialogMode()" (save)="onSave($event)" (cancel)="hideDialog()" />
</p-dialog>

<p-dialog [(visible)]="permissionsDialogVisible" [header]="'Assign Permissions - ' + selectedRole()?.name" [modal]="true" [style]="{ width: '900px' }" [draggable]="false" [resizable]="false">
    <app-assign-permissions [role]="selectedRole()" [rolePermissions]="rolePermissions$()" (save)="onSavePermissions($event)" (cancel)="hidePermissionsDialog()" />
</p-dialog>

<p-toast />
<p-confirmDialog />
